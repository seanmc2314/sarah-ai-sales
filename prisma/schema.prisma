// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum ContactRole {
  OWNER           // Dealer Principal / Owner
  GM              // General Manager
  GSM             // General Sales Manager
  F_AND_I_DIRECTOR // F&I Director
  F_AND_I_MANAGER // F&I Manager
  SALES_MANAGER   // Sales Manager
  SERVICE_MANAGER // Service Manager
  CONTROLLER      // Controller / CFO
  OTHER           // Other
}

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  territories Territory[]
}

model Territory {
  id          String   @id @default(cuid())
  name        String
  description String?
  states      String[] // Array of state codes: ["TX", "OK", "LA"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])

  users       User[]
  dealerships Dealership[] @relation("TerritoryDealerships")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Company & Territory
  companyId     String?
  company       Company?    @relation(fields: [companyId], references: [id])
  territoryId   String?
  territory     Territory?  @relation(fields: [territoryId], references: [id])

  // Password Reset
  passwordResetToken   String?
  passwordResetExpires DateTime?
  mustChangePassword   Boolean   @default(false)

  // Social Media Credentials
  linkedinEmail     String?
  linkedinPassword  String?
  instagramEmail    String?
  instagramPassword String?
  facebookEmail     String?
  facebookPassword  String?
  youtubeEmail      String?
  youtubePassword   String?

  // Microsoft Integration
  microsoftAccessToken  String?
  microsoftRefreshToken String?
  microsoftEmail        String?

  // Twilio Settings
  twilioAccountSid String?
  twilioAuthToken  String?
  twilioFromNumber String?

  // Email Settings
  emailProvider    String?
  emailHost        String?
  emailPort        Int?
  emailUser        String?
  emailPassword    String?

  prospects        Prospect[]
  appointments     Appointment[]
  posts            SocialPost[]
  campaigns        Campaign[]
  notifications    Notification[]
  proposals        Proposal[]
  proposalTemplates ProposalTemplate[]
  followUpSequences FollowUpSequence[]
  emailTemplates   EmailTemplate[]
  agents           Agent[]

  // CRM Relations
  assignedDealerships Dealership[]
  deals               Deal[]
  activities          Activity[]
  uploadedDocuments   Document[]
  assignedTasks       Task[]       @relation("TaskAssignee")
  createdTasks        Task[]       @relation("TaskCreator")
}

model Agent {
  id              String    @id @default(cuid())
  name            String    // "Training Program Agent", "F&I Products Agent"
  slug            String    @unique // "training-agent", "fi-products-agent"
  description     String?
  persona         String    // AI persona/voice for this agent
  targetAudience  String    // Who this agent targets
  products        Json      // Products/services this agent sells
  active          Boolean   @default(true)
  color           String    @default("#3b82f6") // For UI differentiation
  icon            String?   // Icon identifier
  settings        Json?     // Agent-specific settings
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  userId          String
  user            User      @relation(fields: [userId], references: [id])

  prospects       Prospect[]
  campaigns       Campaign[]
  emailTemplates  EmailTemplate[]
  followUpSequences FollowUpSequence[]
  proposalTemplates ProposalTemplate[]

  @@index([active])
  @@index([slug])
}

model Prospect {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  email           String?
  phone           String?
  company         String?
  position        String?
  linkedinUrl     String?
  facebookUrl     String?
  twitterUrl      String?
  source          String    // "cold_list", "linkedin", "referral", "web_scraping", "csv_import", etc.
  status          ProspectStatus @default(COLD)
  industry        String?
  dealership      String?
  dealershipWebsite String?
  location        String?
  employeeCount   Int?
  revenue         String?
  notes           String?
  lastContactDate DateTime?
  nextFollowUp    DateTime?
  enriched        Boolean   @default(false)
  enrichedAt      DateTime?
  leadScore       Int       @default(0) // Lead scoring 0-100
  linkedinData    Json?     // Enriched LinkedIn profile data
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  userId          String
  user            User      @relation(fields: [userId], references: [id])

  agentId         String?
  agent           Agent?    @relation(fields: [agentId], references: [id])

  interactions    Interaction[]
  appointments    Appointment[]
  proposals       Proposal[]
  sequenceEnrollments SequenceEnrollment[]

  @@index([status])
  @@index([nextFollowUp])
  @@index([enriched])
  @@index([agentId])
  @@index([leadScore])
}

enum ProspectStatus {
  COLD
  CONTACTED
  INTERESTED
  APPOINTMENT_SET
  PROPOSAL_SENT
  CLOSED_WON
  CLOSED_LOST
  DO_NOT_CONTACT
}

model Interaction {
  id          String         @id @default(cuid())
  type        InteractionType
  content     String?
  result      String?
  scheduledAt DateTime?
  completedAt DateTime?
  successful  Boolean?
  notes       String?
  createdAt   DateTime       @default(now())

  prospectId  String
  prospect    Prospect       @relation(fields: [prospectId], references: [id])

  @@index([type])
  @@index([scheduledAt])
}

enum InteractionType {
  EMAIL
  LINKEDIN_MESSAGE
  LINKEDIN_CONNECTION
  PHONE_CALL
  SOCIAL_MEDIA_COMMENT
  SOCIAL_MEDIA_POST
  MEETING
}

model Appointment {
  id          String    @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  status      AppointmentStatus @default(SCHEDULED)
  meetingLink String?
  location    String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  prospectId  String
  prospect    Prospect  @relation(fields: [prospectId], references: [id])

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  @@index([startTime])
  @@index([status])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Campaign {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        CampaignType
  status      CampaignStatus @default(DRAFT)
  targetAudience String?
  content     String?
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  stats       Json?     // Campaign statistics (sent, opened, clicked, replied)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])

  posts       SocialPost[]
}

enum CampaignType {
  LINKEDIN_OUTREACH
  EMAIL_SEQUENCE
  SOCIAL_MEDIA
  PHONE_CAMPAIGN
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
}

model SocialPost {
  id          String     @id @default(cuid())
  platform    Platform
  content     String
  mediaUrl    String?
  mediaType   String?
  scheduledAt DateTime?
  publishedAt DateTime?
  status      PostStatus @default(DRAFT)
  engagement  Json?      // likes, comments, shares, etc.
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  userId      String
  user        User       @relation(fields: [userId], references: [id])

  campaignId  String?
  campaign    Campaign?  @relation(fields: [campaignId], references: [id])

  @@index([platform])
  @@index([scheduledAt])
}

enum Platform {
  LINKEDIN
  INSTAGRAM
  FACEBOOK
  YOUTUBE
  TWITTER
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

model VideoContent {
  id          String    @id @default(cuid())
  title       String
  description String?
  filename    String
  url         String
  thumbnail   String?
  duration    Int?      // in seconds
  size        Int?      // in bytes
  format      String?
  tags        String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tags])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  sentAt    DateTime?
  createdAt DateTime         @default(now())

  userId    String
  user      User             @relation(fields: [userId], references: [id])

  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  APPOINTMENT_SCHEDULED
  APPOINTMENT_REMINDER
  PROSPECT_RESPONDED
  CAMPAIGN_COMPLETED
  SYSTEM_ALERT
}

model KnowledgeBase {
  id          String   @id @default(cuid())
  category    String
  title       String
  content     String
  tags        String[]
  version     String   @default("1.0")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([tags])
}

model AIConversation {
  id          String    @id @default(cuid())
  prospectId  String?
  context     String    // "prospecting", "appointment_setting", "follow_up"
  messages    Json      // Array of conversation messages
  summary     String?
  outcome     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([prospectId])
  @@index([context])
}

model Proposal {
  id              String         @id @default(cuid())
  title           String
  content         String         // AI-generated proposal content
  personalizedPitch String?      // Personalized pitch section
  roiCalculation  Json?          // ROI calculation data
  trainingProgram String?        // Supreme One training program details
  status          ProposalStatus @default(DRAFT)
  sentAt          DateTime?
  viewedAt        DateTime?
  viewCount       Int            @default(0)
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  followUpCount   Int            @default(0)
  lastFollowUp    DateTime?
  expiresAt       DateTime?
  metadata        Json?          // Additional data like pricing, packages, etc.
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  prospectId      String
  prospect        Prospect       @relation(fields: [prospectId], references: [id])

  userId          String
  user            User           @relation(fields: [userId], references: [id])

  templateId      String?
  template        ProposalTemplate? @relation(fields: [templateId], references: [id])

  @@index([status])
  @@index([sentAt])
  @@index([prospectId])
}

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

model ProposalTemplate {
  id          String    @id @default(cuid())
  name        String
  description String?
  subject     String?   // Email subject line
  template    String    // Template with placeholders like {{firstName}}, {{dealership}}, etc.
  pitchTemplate String? // Template for personalized pitch
  roiTemplate String?   // Template for ROI calculation
  active      Boolean   @default(true)
  category    String?   // "dealership_owner", "gm", "president", etc.
  metadata    Json?     // Variables, settings, etc.
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])

  proposals   Proposal[]

  @@index([active])
  @@index([category])
}

model FollowUpSequence {
  id          String    @id @default(cuid())
  name        String
  description String?
  active      Boolean   @default(true)
  triggerEvent String   // "proposal_sent", "no_response_7days", "viewed_not_accepted", etc.
  delayDays   Int       @default(0) // Days to wait before starting sequence
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])

  steps       FollowUpStep[]
  enrollments SequenceEnrollment[]

  @@index([active])
  @@index([triggerEvent])
}

model FollowUpStep {
  id          String       @id @default(cuid())
  stepNumber  Int          // Order in sequence (1, 2, 3, etc.)
  name        String
  type        FollowUpType
  delayDays   Int          // Days after previous step (or sequence start for step 1)
  delayHours  Int          @default(0) // Additional hours for precise timing
  subject     String?      // For emails
  content     String       // Email body, LinkedIn message, etc.
  channel     String       // "email", "linkedin", "sms", "phone", etc.
  aiGenerated Boolean      @default(true) // Whether content should be AI-personalized
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  sequenceId  String
  sequence    FollowUpSequence @relation(fields: [sequenceId], references: [id])

  @@index([sequenceId, stepNumber])
}

enum FollowUpType {
  EMAIL
  LINKEDIN_MESSAGE
  SMS
  PHONE_REMINDER
  SOCIAL_MEDIA_COMMENT
}

model SequenceEnrollment {
  id              String    @id @default(cuid())
  status          SequenceStatus @default(ACTIVE)
  currentStep     Int       @default(0) // Which step they're on
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  pausedAt        DateTime?
  cancelledAt     DateTime?
  lastStepSentAt  DateTime?
  nextStepDue     DateTime?
  notes           String?

  prospectId      String
  prospect        Prospect  @relation(fields: [prospectId], references: [id])

  sequenceId      String
  sequence        FollowUpSequence @relation(fields: [sequenceId], references: [id])

  @@index([status])
  @@index([nextStepDue])
  @@index([prospectId])
  @@index([sequenceId])
}

enum SequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  BOUNCED
}

model EmailTemplate {
  id          String    @id @default(cuid())
  name        String
  description String?
  subject     String
  body        String    // Template with placeholders
  category    String?   // "initial_outreach", "follow_up", "proposal", etc.
  active      Boolean   @default(true)
  tags        String[]
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])

  @@index([active])
  @@index([category])
  @@index([tags])
}

model LinkedInAccount {
  id            String    @id @default(cuid())
  userId        String    @unique
  accessToken   String
  expiresAt     DateTime
  linkedinId    String?
  linkedinName  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
}

// ============= CRM MODELS =============

model Dealership {
  id                String            @id @default(cuid())
  name              String
  legalName         String?
  status            DealershipStatus  @default(PROSPECT)
  website           String?
  phone             String?
  email             String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String            @default("USA")

  // Business info
  dealerGroup       String?           // Parent company if part of group
  brands            String[]          // ["Toyota", "Honda", etc.]
  employeeCount     Int?
  annualRevenue     String?
  fiManagerCount    Int?

  // Relationship tracking
  customerSince     DateTime?
  churnedAt         DateTime?
  contractEndDate   DateTime?

  // Agreement details
  monthlyValue      Float?            // Monthly contract value
  contractType      String?           // "training_only", "full_service", etc.

  // Live customer indicator
  isLive            Boolean           @default(false)
  liveActivatedAt   DateTime?

  // Notes and metadata
  notes             String?
  tags              String[]
  metadata          Json?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  contacts          Contact[]
  deals             Deal[]
  activities        Activity[]
  documents         Document[]
  tasks             Task[]

  // Ownership
  assignedUserId    String?
  assignedUser      User?             @relation(fields: [assignedUserId], references: [id])

  // Territory
  territoryId       String?
  territory         Territory?        @relation("TerritoryDealerships", fields: [territoryId], references: [id])

  @@index([status])
  @@index([isLive])
  @@index([assignedUserId])
  @@index([territoryId])
  @@index([name])
}

enum DealershipStatus {
  PROSPECT
  QUALIFIED
  MEETING_SCHEDULED
  PROPOSAL_SENT
  NEGOTIATION
  ACTIVE_CUSTOMER
  CHURNED
  DO_NOT_CONTACT
}

model Contact {
  id                String          @id @default(cuid())
  firstName         String
  lastName          String
  email             String?
  phone             String?
  mobile            String?
  role              ContactRole     @default(OTHER)
  position          String?         // Custom title if role doesn't fit
  department        String?
  isPrimary         Boolean         @default(false)

  // Social profiles
  linkedinUrl       String?
  facebookUrl       String?
  twitterUrl        String?

  // AI Lead scoring
  leadScore         Int             @default(0)
  leadScoreReason   String?
  scoredAt          DateTime?

  // Communication preferences
  preferredChannel  String?         // "email", "phone", "linkedin"
  timezone          String?
  doNotContact      Boolean         @default(false)

  notes             String?
  tags              String[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  dealershipId      String?
  dealership        Dealership?     @relation(fields: [dealershipId], references: [id])

  activities        Activity[]
  deals             Deal[]
  tasks             Task[]

  // Link to legacy Prospect if migrated
  legacyProspectId  String?

  @@index([dealershipId])
  @@index([leadScore])
  @@index([email])
}

model Deal {
  id                String          @id @default(cuid())
  title             String
  value             Float           @default(0)
  monthlyRecurring  Float?          // MRR for subscription deals

  // Pipeline stages
  stage             DealStage       @default(LEAD)
  probability       Int             @default(10)   // 0-100%

  // Expected close
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  // Deal details
  dealType          String?         // "new_business", "upsell", "renewal"
  source            String?         // "website", "referral", "cold_outreach"
  lostReason        String?

  notes             String?
  tags              String[]
  metadata          Json?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  closedAt          DateTime?

  // Relations
  dealershipId      String
  dealership        Dealership      @relation(fields: [dealershipId], references: [id])

  contactId         String?
  contact           Contact?        @relation(fields: [contactId], references: [id])

  ownerId           String
  owner             User            @relation(fields: [ownerId], references: [id])

  activities        Activity[]
  tasks             Task[]

  @@index([stage])
  @@index([ownerId])
  @@index([dealershipId])
  @@index([expectedCloseDate])
}

enum DealStage {
  LEAD
  QUALIFIED
  MEETING_SCHEDULED
  PROPOSAL_SENT
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model Activity {
  id                String          @id @default(cuid())
  type              ActivityType
  subject           String
  description       String?

  // For calls/meetings
  duration          Int?            // in minutes
  outcome           String?         // "connected", "voicemail", "no_answer"

  // For emails
  emailSubject      String?
  emailContent      String?
  emailSentAt       DateTime?
  emailOpenedAt     DateTime?
  emailClickedAt    DateTime?

  // AI interaction specific
  aiPrompt          String?
  aiResponse        String?
  aiModel           String?

  // Timestamps
  scheduledAt       DateTime?
  completedAt       DateTime?

  notes             String?
  metadata          Json?

  createdAt         DateTime        @default(now())

  // Relations
  dealershipId      String?
  dealership        Dealership?     @relation(fields: [dealershipId], references: [id])

  contactId         String?
  contact           Contact?        @relation(fields: [contactId], references: [id])

  dealId            String?
  deal              Deal?           @relation(fields: [dealId], references: [id])

  userId            String
  user              User            @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([dealershipId])
  @@index([contactId])
  @@index([dealId])
  @@index([createdAt])
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  CALL_OUTBOUND
  CALL_INBOUND
  MEETING
  NOTE
  LINKEDIN_MESSAGE
  LINKEDIN_CONNECTION
  AI_INTERACTION
  TASK_COMPLETED
  STATUS_CHANGE
  DOCUMENT_UPLOAD
  SOCIAL_POST
}

model Document {
  id                String           @id @default(cuid())
  name              String
  originalName      String
  description       String?

  // File info
  filePath          String           // Local path: /uploads/documents/{dealershipId}/{filename}
  fileSize          Int              // bytes
  mimeType          String
  fileExtension     String

  // Categorization
  category          DocumentCategory
  tags              String[]

  // For agreements/contracts
  validFrom         DateTime?
  validUntil        DateTime?
  signedAt          DateTime?
  signedBy          String?

  // Future S3 migration
  s3Key             String?
  s3Bucket          String?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  dealershipId      String
  dealership        Dealership       @relation(fields: [dealershipId], references: [id])

  uploadedById      String
  uploadedBy        User             @relation(fields: [uploadedById], references: [id])

  @@index([dealershipId])
  @@index([category])
}

enum DocumentCategory {
  AGREEMENT
  CONTRACT
  PROPOSAL
  INVOICE
  NDA
  TRAINING_MATERIAL
  REPORT
  OTHER
}

model Task {
  id                String          @id @default(cuid())
  title             String
  description       String?

  // Timing
  dueDate           DateTime?
  dueTime           String?         // "09:00"
  reminderAt        DateTime?

  // Status
  priority          TaskPriority    @default(MEDIUM)
  status            TaskStatus      @default(PENDING)
  completedAt       DateTime?

  // Categorization
  taskType          String?         // "follow_up", "call", "email", "meeting"

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  dealershipId      String?
  dealership        Dealership?     @relation(fields: [dealershipId], references: [id])

  contactId         String?
  contact           Contact?        @relation(fields: [contactId], references: [id])

  dealId            String?
  deal              Deal?           @relation(fields: [dealId], references: [id])

  assignedToId      String
  assignedTo        User            @relation("TaskAssignee", fields: [assignedToId], references: [id])

  createdById       String
  createdBy         User            @relation("TaskCreator", fields: [createdById], references: [id])

  @@index([status])
  @@index([dueDate])
  @@index([assignedToId])
  @@index([dealershipId])
  @@index([priority])
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
